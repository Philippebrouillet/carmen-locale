import{c as v}from"./clock.svelte.pa43Gjrj.js";import{O as x}from"./scheduler.BoY_d1jh.js";function E(m,n){return m.getFullYear()===n.getFullYear()&&m.getMonth()===n.getMonth()&&m.getDate()===n.getDate()}function B(m,n,i,o=15*60){if(m==null)return[];const r=m.workers.filter(e=>e.status!="DISABLED");let a=[];for(let e of r){const t=e.tickets||[];let u=t.map(d=>d.canceledTime||d.doneTime).filter(d=>d!=null).map(d=>d.getTime()),l=t.filter(d=>d.doneTime==null&&d.canceledTime==null),s=u.length>0?new Date(Math.max(...u)):null,g=e.status||"STOPED";g!=="AVAILABLE"&&g!=="UNAVAILABLE"&&g!=="STOPED"&&(g="STOPED");const T=new Date(n);T.setHours(e.endHour,e.endMinute,0,0);const c=new Date(n);c.setHours(e.startHour,e.startMinute,0,0);const f=A(l,n,i,o),D=n<=T&&n>=c&&g==="AVAILABLE",w=f.next.getTime()>=T.getTime(),S=p(e,f==null?void 0:f.next,D,w,f.ticketBefore,f.isLate),k={id:e.id,name:e.name,avatar:e.avatar,status:g,planning:[],tickets:l,waitingSince:s,nextAvailable:f,formatedStatus:S,startWorkerDate:c,endWorkerDate:T,isWorking:D,isFullSlotBooked:w};a.push(k)}return a.sort((e,t)=>{var u,l,s,g,T,c;return e.status=="STOPED"&&t.status=="STOPED"?e.name.localeCompare(t.name):e.status=="STOPED"&&t.status!="STOPED"?1:e.status!="STOPED"&&t.status=="STOPED"?-1:e.nextAvailable!=null&&((u=e.nextAvailable)==null?void 0:u.next.getTime())==((l=t.nextAvailable)==null?void 0:l.next.getTime())?e.waitingSince==t.waitingSince?0:(e.waitingSince==null?0:e.waitingSince.getTime())-(t.waitingSince==null?0:t.waitingSince.getTime()):(((g=(s=e.nextAvailable)==null?void 0:s.next)==null?void 0:g.getTime())??0)-(((c=(T=t.nextAvailable)==null?void 0:T.next)==null?void 0:c.getTime())??0)}),a.sort((e,t)=>{const u={available:0,waiting:1,unavailable:2},l=u[e.formatedStatus]??3,s=u[t.formatedStatus]??3;return l!==s?l-s:e.name.localeCompare(t.name)}),a}function A(m,n,i,o=15*60,r){E(n,i)||(m=m.filter(s=>s.rdvTime&&s.rdvTime.getTime()>i.getTime()));const a=h(m,n);let e=0,t=!0;if(a.length==0)return{ticketBefore:e,next:i,isFirstSlot:t,createHole:n.getTime()<i.getTime()};for(let s of a){if(s.time.getTime()+s.durationS*1e3<i.getTime()){e+=1;continue}let T=s.timeBefore,c=s.time.getTime()-s.timeBefore,f=!1;if(c<i.getTime()&&(T-=i.getTime()-s.time.getTime(),c=i.getTime(),f=!0),T>=o*1e3){const D=new Date(c);return{ticketBefore:e,next:D,isFirstSlot:t,createHole:f,isLate:!0,timeLate:i.getTime()-D.getTime()}}T>0&&(t=!1),e+=1}const u=a[m.length-1],l=new Date(u.time.getTime()+u.durationS*1e3);return i.getTime()>l.getTime()?{ticketBefore:e,next:i,isFirstSlot:t,createHole:!0,isLate:!0,timeLate:i.getTime()-l.getTime()}:{ticketBefore:e,next:l,isFirstSlot:t,createHole:!1}}function h(m,n){let i=[],o=new Date(n);for(let r of m){let a=new Date(o),e=0,t=r.durationS*1e3;if(r.startedTime)if(new Date(r.startedTime).getTime()+t<o.getTime())a=new Date(r.startedTime);else{let l=o.getTime()-new Date(r.startedTime).getTime();a=new Date(r.startedTime),o.setTime(o.getTime()+(t-l))}else r.rdvTime!=null&&o<new Date(r.rdvTime)?(a=new Date(r.rdvTime),e=new Date(r.rdvTime).getTime()-o.getTime()):a=new Date(o),o.setTime(a.getTime()+t);i.push({id:r.id,durationS:r.durationS,time:a,timeBefore:e})}return i}const p=(m,n,i,o,r,a)=>{let e="unavailable";const t=new Date(x(v)),u=new Date(t.getTime()+5*60*1e3),l=5*60*1e3;return i===!1||m.status==="STOPED"||n==null||o?(e="unavailable",e):a&&r>0?(e="waiting",e):(Math.abs(n.getTime()-u.getTime())<l?e="available":e="waiting",e)};export{B as c,A as n,E as s};
