import{e as w}from"../chunks/index.g5YcAAdQ.js";import{P as T}from"../chunks/public.BeJSVsf1.js";import{f as b,m as I}from"../chunks/Location.Cha5LnI8.js";import{s as J,z as L,e as M,a as O,A as E,c as j,q as H,f as h,g as q,b as P,B as A,m as k,h as B,i as D,C as R,D as $,E as z,k as N,F,G}from"../chunks/scheduler.BoY_d1jh.js";import{S as U,i as W,a as K,t as Q}from"../chunks/index.C5ymHmkt.js";import{p as V}from"../chunks/stores.D3-ZdzJB.js";import{l as p}from"../chunks/location.store.a1q1W2o2.js";async function X({fetch:l,params:o}){const d=o.locationSlug,c=await l(`${T}/api/v3/location/${d}`),m=await l(`${T}/api/v1/location/${d}/config`);if(c.ok){const u=await c.json(),f=await m.json();return console.log("configJson",f),{...b(u),config:f.config}}return c.status==404?w(404,"Not found"):w(500,"internal server error")}const re=Object.freeze(Object.defineProperty({__proto__:null,load:X},Symbol.toStringTag,{value:"Module"}));function Y(l){let o,d="",c,m,u,f,a;const s=l[3].default,r=L(s,l,l[2],null);return{c(){o=M("script"),o.innerHTML=d,m=O(),u=M("main"),r&&r.c(),this.h()},l(n){const t=E("svelte-134wda8",document.head);o=j(t,"SCRIPT",{src:!0,"data-svelte-h":!0}),H(o)!=="svelte-jifc8h"&&(o.innerHTML=d),t.forEach(h),m=q(n),u=j(n,"MAIN",{class:!0});var i=P(u);r&&r.l(i),i.forEach(h),this.h()},h(){A(o.src,c="https://js.stripe.com/v3")||k(o,"src",c),o.async=!0,k(u,"class",f=I[l[0].location.theme])},m(n,t){B(document.head,o),D(n,m,t),D(n,u,t),r&&r.m(u,null),a=!0},p(n,[t]){r&&r.p&&(!a||t&4)&&R(r,s,n,n[2],a?z(s,n[2],t,null):$(n[2]),null),(!a||t&1&&f!==(f=I[n[0].location.theme]))&&k(u,"class",f)},i(n){a||(K(r,n),a=!0)},o(n){Q(r,n),a=!1},d(n){n&&(h(m),h(u)),h(o),r&&r.d(n)}}}function Z(l,o,d){let c,m;N(l,p,t=>d(0,c=t)),N(l,V,t=>d(5,m=t));let{$$slots:u={},$$scope:f}=o,{data:a}=o;console.log("layout data",a);let s=null;p.set(a);async function r(){const t=m.params.locationSlug,i=await fetch(`${T}/api/v2/location/${t}`);if(i.ok){const _=await i.json(),g=b(_);p.set(g)}}function n(t){const i=JSON.parse(t.data);if(i.type=="sync-v2")r();else if(i.type=="updateWorkerTime")p.update(_=>{const g=JSON.parse(JSON.stringify(_));return{...g,workers:g.workers.map(v=>v.id===i.workerId?{...v,startHour:i.startHour,startMinute:i.startMinute,endHour:i.endHour,endMinute:i.endMinute}:v)}});else if(i.type=="sync"){const _=i.queueLines??[],g=_.flatMap(e=>e.tickets).map(e=>({id:e.id,workerId:e.doctorId,durationS:e.durationS,expectedTime:new Date(e.expectedTime),canceledTime:e.canceledTime?new Date(e.canceledTime):null,doneTime:e.doneTime?new Date(e.doneTime):null,rdvTime:e.rdvTime?new Date(e.rdvTime):null,startedTime:e.startedTime?new Date(e.startedTime):null,details:null})),v=_.filter(e=>e.doctorId!=null).map(e=>({id:e.id,name:e.name,avatar:e.avatar,status:e.status,tickets:g.filter(y=>y.workerId==e.id)}));p.update(e=>{const y=JSON.parse(JSON.stringify(e));return y.workers=e.workers.map(S=>({...S,...v.find(C=>C.id==S.id)})),y})}}return F(()=>{if(c==null||c==null){p.set(a);return}(c.location.slug!=a.location.slug||s==null)&&(s!=null&&(s.close(),s=null),s=new EventSource(`${T}/api/v2/location/events?token=${a.location.id}`),s.onopen=()=>{},s.onmessage=n,s.onerror=t=>{console.error(`[!] sse error ${t}`)}),p.set(a)}),G(()=>{s!=null&&(s.close(),s=null)}),l.$$set=t=>{"data"in t&&d(1,a=t.data),"$$scope"in t&&d(2,f=t.$$scope)},[c,a,f,u]}class ie extends U{constructor(o){super(),W(this,o,Z,Y,J,{data:1})}}export{ie as component,re as universal};
